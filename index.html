<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>丹美股份有限公司 - 發貨單管理系統</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
       
        body {
            margin: 10px;
            background-color: #f0f0f0;
            color: #333;
            font-size: 14px;
            overflow-x: hidden;
        }
       
        .tabs-container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #aaa;
            padding: 5px;
            overflow: hidden;
        }
        
        .tabs-header {
            display: flex;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ccc;
            padding: 5px 5px 0 5px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        
        .tab {
            padding: 8px 15px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            margin-right: 3px;
            font-size: 13px;
            white-space: nowrap;
            max-width: 150px;
            min-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            flex-shrink: 0;
        }
        
        .tab.active {
            background-color: white;
            font-weight: bold;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        
        .tab-close {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #ff0000;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-close:hover {
            background-color: #ffcccc;
            border-radius: 50%;
        }
        
        .add-tab {
            padding: 8px 10px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .add-tab:hover {
            background-color: #3a5a80;
        }
       
        .invoice-container {
            padding: 10px;
            display: none;
            width: 100%;
            overflow-x: auto;
        }
        
        .invoice-container.active {
            display: block;
        }
       
        .header {
            margin-bottom: 10px;
            position: relative;
        }
       
        .company-name {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3px;
        }
       
        .invoice-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 3px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .invoice-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .salesperson-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }
       
        .invoice-number {
            text-align: right;
            font-size: 12px;
            color: #c0392b;
            margin-bottom: 8px;
        }
       
        .info-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
       
        .client-info {
            width: 48%;
            min-width: 300px;
        }
       
        .order-info {
            width: 48%;
            min-width: 300px;
            text-align: right;
        }
       
        .info-row {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
       
        .info-label {
            font-weight: bold;
            min-width: 70px;
            font-size: 13px;
        }
       
        .info-input {
            flex: 1;
            padding: 3px 5px;
            border: 1px solid #aaa;
            border-radius: 2px;
            font-size: 12px;
            margin-left: 5px;
            max-width: 250px;
        }
        
        .salesperson-select {
            width: 120px;
            padding: 3px 5px;
            border: 1px solid #aaa;
            border-radius: 2px;
            font-size: 12px;
            margin-left: 5px;
            background-color: white;
        }
        
        .salesperson-display {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-left: 5px;
        }
       
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 2px;
        }
       
        .date-input {
            padding: 3px;
            border: 1px solid #aaa;
            border-radius: 2px;
            text-align: center;
            font-size: 12px;
        }
        
        /* 調整年份輸入框寬度 */
        #year-input {
            width: 60px; /* 增加寬度以容納4位數年份 */
        }
        
        .month-input {
            width: 40px;
        }
        
        .day-input {
            width: 40px;
        }
       
        .date-label {
            margin: 0 2px;
            font-size: 12px;
        }
       
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
            table-layout: fixed;
        }
       
        .products-table th {
            background-color: #e0e0e0;
            color: #333;
            padding: 6px 3px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #999;
            font-size: 12px;
        }
       
        .products-table td {
            padding: 4px 3px;
            border: 1px solid #999;
            vertical-align: top;
            font-size: 12px;
        }
       
        .product-name {
            width: 220px;
            overflow: hidden;
            word-wrap: break-word;
        }
        
        /* 可點選的方框樣式 */
        .checkbox-container {
            display: inline-block;
            margin-right: 2px;
        }
        
        .custom-checkbox {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 1px solid #aaa;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            vertical-align: middle;
            margin-right: 3px;
            background-color: white;
        }
        
        .custom-checkbox.checked {
            background-color: #27ae60;
            border-color: #219653;
        }
        
        .custom-checkbox.checked::after {
            content: "✓";
            position: absolute;
            top: -1px;
            left: 3px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* 選項按鈕樣式 */
        .option-button {
            display: inline-block;
            padding: 1px 4px;
            margin: 0 2px;
            border: 1px solid #aaa;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            background-color: white;
        }
        
        .option-button.selected {
            background-color: #27ae60;
            color: white;
            border-color: #219653;
        }
        
        /* 促銷組合按鈕樣式 */
        .promo-button {
            display: inline-block;
            padding: 2px 5px;
            margin: 1px;
            border: 1px solid #3498db;
            border-radius: 3px;
            font-size: 10px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .promo-button:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
       
        .price-col {
            width: 80px;
            text-align: center;
        }
        
        .cost-col {
            width: 70px;
            text-align: center;
        }
        
        /* 修改欄位背景為白色 */
        .unit-col, .quantity-col, .gift-col, .amount-col, .notes-col {
            background-color: white !important;
        }
        
        .unit-col {
            width: 50px;
            text-align: center;
        }
        
        .quantity-col, .gift-col {
            width: 50px;
            text-align: center;
        }
        
        .amount-col {
            width: 70px;
            text-align: center;
        }
        
        .notes-col {
            width: 180px;
            font-size: 11px;
            color: #666;
            word-wrap: break-word;
        }
       
        .number-input {
            width: 45px;
            padding: 3px;
            border: 1px solid #aaa;
            border-radius: 2px;
            text-align: center;
            font-size: 12px;
        }
       
        .amount-cell {
            font-weight: bold;
        }
       
        .total-section {
            margin-bottom: 15px;
            width: 100%;
        }
       
        .total-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
       
        .total-label {
            font-weight: bold;
            margin-right: 5px;
        }
       
        .total-amount {
            font-weight: bold;
            color: #c0392b;
            font-size: 14px;
        }
       
        .footer-section {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #aaa;
            flex-wrap: wrap;
        }
       
        .sales-info {
            width: 48%;
            min-width: 300px;
        }
       
        .delivery-info {
            width: 48%;
            min-width: 300px;
        }
       
        .signature-section {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #aaa;
        }
       
        .signature-line {
            width: 200px;
            border-top: 1px solid #333;
            margin: 0 auto;
            padding-top: 3px;
        }
       
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
       
        .btn {
            padding: 6px 12px;
            border: 1px solid #aaa;
            border-radius: 3px;
            font-size: 13px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        
        /* 移除計算按鈕的樣式，因為我們不再需要它 */
       
        .btn-clear {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
       
        .btn-clear:hover {
            background-color: #c0392b;
        }
        
        .btn-save {
            background-color: #27ae60;
            color: white;
            border-color: #219653;
        }
        
        .btn-save:hover {
            background-color: #219653;
        }
        
        .btn-lock {
            background-color: #f39c12;
            color: white;
            border-color: #d68910;
        }
        
        .btn-lock:hover {
            background-color: #d68910;
        }
        
        .btn-unlock {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .btn-unlock:hover {
            background-color: #2980b9;
        }
        
        .btn-clear-all {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }
        
        .btn-clear-all:hover {
            background-color: #c0392b;
        }
        
        .btn-download {
            background-color: #9b59b6;
            color: white;
            border-color: #8e44ad;
        }
        
        .btn-download:hover {
            background-color: #8e44ad;
        }
        
        .btn-clear-current {
            background-color: #e67e22;
            color: white;
            border-color: #d35400;
        }
        
        .btn-clear-current:hover {
            background-color: #d35400;
        }
       
        .warning-note {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            line-height: 1.3;
        }
       
        .radio-group {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px;
        }
       
        .radio-label {
            display: flex;
            align-items: center;
        }
       
        .radio-label input {
            margin-right: 5px;
        }
       
        .summary-cell {
            font-weight: bold;
            text-align: center;
            background-color: #f5f5f5;
        }
        
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .client-counter {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        
        .control-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tab-name-text {
            display: inline-block;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }
        
        /* 鎖定狀態樣式 */
        .locked .info-input,
        .locked .date-input,
        .locked .number-input,
        .locked input[type="radio"],
        .locked .btn:not(.btn-unlock),
        .locked .salesperson-select,
        .locked .custom-checkbox,
        .locked .option-button,
        .locked .promo-button {
            background-color: #f5f5f5 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            opacity: 0.7;
        }
        
        /* 彈出視窗樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .modal h3 {
            margin-top: 0;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-confirm {
            background-color: #27ae60;
            color: white;
        }
        
        .modal-cancel {
            background-color: #7f8c8d;
            color: white;
        }
        
        /* 促銷組合彈出視窗樣式 */
        .promo-modal .promo-option {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        
        .promo-modal .promo-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .promo-modal .promo-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .promo-modal .group-input {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .promo-modal .group-input label {
            margin-right: 10px;
            font-size: 13px;
        }
        
        .promo-modal .group-input input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
        }
        
        .promo-modal .total-calc {
            margin-top: 5px;
            font-size: 12px;
            color: #27ae60;
            font-weight: bold;
        }
        
        /* 產品分行顯示樣式 */
        .product-line {
            display: block;
            margin-bottom: 3px;
        }
        
        .product-main-name {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        /* 多選項產品顯示樣式 */
        .product-option-row {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .product-option-label {
            font-size: 11px;
            color: #333;
            margin-left: 5px;
            margin-right: 5px;
            min-width: 70px;
            white-space: nowrap;
        }
        
        /* 多選項數量輸入框樣式 - 在數量欄位中 */
        .quantity-options-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .quantity-option-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-bottom: 3px;
        }
        
        .quantity-option-row .option-label {
            font-size: 10px;
            color: #666;
            min-width: auto;
            margin-right: 2px;
            white-space: nowrap;
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .option-quantity-in-quantity-col {
            width: 40px;
            padding: 2px;
            border: 1px solid #aaa;
            border-radius: 2px;
            text-align: center;
            font-size: 11px;
        }
        
        /* 多選項搭贈輸入框樣式 - 在搭贈欄位中 */
        .gift-options-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .gift-option-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-bottom: 3px;
        }
        
        .gift-option-row .option-label {
            font-size: 10px;
            color: #666;
            min-width: auto;
            margin-right: 2px;
            white-space: nowrap;
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .option-gift-in-gift-col {
            width: 40px;
            padding: 2px;
            border: 1px solid #aaa;
            border-radius: 2px;
            text-align: center;
            font-size: 11px;
        }
        
        /* 多選項金額顯示樣式 - 在金額欄位中 */
        .amount-options-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .amount-option-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-bottom: 3px;
            font-size: 10px;
        }
        
        .amount-option-row .option-label {
            font-size: 10px;
            color: #666;
            min-width: auto;
            margin-right: 2px;
            white-space: nowrap;
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .option-amount-in-amount-col {
            font-size: 10px;
            color: #27ae60;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }
        
        .amount-total-row {
            margin-top: 3px;
            padding-top: 3px;
            border-top: 1px dotted #ccc;
            font-weight: bold;
            color: #c0392b;
            font-size: 11px;
            text-align: center;
        }
        
        /* 勾選框在產品名稱欄位的樣式 */
        .product-option-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }
        
        /* 調整文字顯示，確保不超出格子 */
        .option-label-small {
            font-size: 10px;
            margin-left: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }
        
        /* 響應式調整 */
        @media (max-width: 768px) {
            .client-info, .order-info, .sales-info, .delivery-info {
                width: 100%;
                min-width: 100%;
            }
            
            .info-section, .footer-section {
                flex-direction: column;
            }
            
            .order-info {
                text-align: left;
                margin-top: 10px;
            }
            
            .tabs-container {
                margin: 5px;
                padding: 3px;
            }
            
            .control-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .products-table {
                font-size: 11px;
            }
            
            .product-name {
                width: 150px;
            }
            
            .notes-col {
                width: 120px;
            }
            
            .option-button {
                padding: 1px 3px;
                font-size: 10px;
                margin: 0 1px;
            }
            
            .promo-button {
                padding: 2px 3px;
                font-size: 9px;
                min-width: 50px;
            }
            
            .invoice-title-wrapper {
                flex-direction: column;
                gap: 5px;
            }
            
            .quantity-option-row, .gift-option-row, .amount-option-row {
                flex-wrap: wrap;
                justify-content: flex-start;
            }
            
            .option-quantity-in-quantity-col,
            .option-gift-in-gift-col {
                width: 35px;
            }
            
            .quantity-option-row .option-label,
            .gift-option-row .option-label,
            .amount-option-row .option-label {
                font-size: 9px;
                min-width: 30px;
                max-width: 60px;
            }
            
            .option-amount-in-amount-col {
                font-size: 9px;
                min-width: 35px;
            }
            
            .option-label-small {
                font-size: 9px;
                max-width: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="tabs-container" id="tabs-container">
        <!-- 分頁標籤區 -->
        <div class="tabs-header" id="tabs-header">
            <!-- 分頁標籤將由JavaScript動態生成 -->
        </div>
        
        <!-- 控制欄 -->
        <div class="control-bar">
            <div class="client-counter">目前客戶數: <span id="client-count">1</span></div>
            <div class="control-buttons">
                <button class="btn btn-save" id="save-page">儲存頁面</button>
                <button class="btn btn-download" id="download-csv">下載CSV</button>
                <button class="btn btn-lock" id="lock-page">鎖定頁面</button>
                <button class="btn btn-unlock" id="unlock-page">解除鎖定</button>
                <button class="btn btn-clear-all" id="clear-all">清除全部數據</button>
                <button class="btn btn-clear-current" id="clear-current">清除此分頁數據</button>
                <button class="add-tab" id="add-tab">+ 新增客戶</button>
            </div>
        </div>
        
        <!-- 發貨單容器 - 每個客戶一個 -->
        <div id="invoices-container">
            <!-- 發貨單將由JavaScript動態生成 -->
        </div>
    </div>

    <script>
        // 產品資料 - 根據Excel中的公式修正
        const products = [
            { id: 1, name: "小哈氟氟錠 100粒 0.25mg □", price: "400 / 瓶", cost: "280", unit: "/ 瓶", notes: "", formula: "quantity * 280", selections: [] },
            { id: 2, name: "史丹氟氟錠 100粒", price: "300 / 380 瓶", cost: "200 / 280", unit: "/ 瓶", notes: "both:36+6: 7200 ,1mg: 36+6: 10080, 0.25mg : 120 :19800, 1mg 120:27600", formula: "special", selections: [], options: ["0.25mg", "1mg"], optionPrices: { "0.25mg": 200, "1mg": 280 } },
            { id: 3, name: "四季塗佈刷(150束毛) 100支入-盒裝", price: "", cost: "250", unit: "/ 盒", notes: "", formula: "quantity * 250", selections: [] },
            { id: 4, name: "四季兒童歡樂學習軟毛牙刷-(汽車造型)", price: "30 / 支", cost: "320", unit: "/ 打", notes: "", formula: "quantity * 320", selections: [] },
            { id: 5, name: "四季敏感牙專用超軟毛牙刷2入/卡(12卡/盒)", price: "90 / 卡", cost: "900", unit: "/ 盒", notes: "4+1打 3600 ,15+5打13500", formula: "quantity * 900", selections: [] },
            { id: 6, name: "四季晶炫炭螺旋柔尖毛牙刷6入/桶(12桶/盒)", price: "180 / 桶", cost: "1800", unit: "/ 盒", notes: "", formula: "quantity * 1800", selections: [] },
            { id: 7, name: "四季超氟淨寬扁高效能牙線50M", price: "80/卡", cost: "900", unit: "/ 打", notes: "新客戶兩打1440 舊客戶4+1打3600", formula: "quantity * 900", selections: [] },
            { id: 8, name: "四季舒敏護齒牙間刷I型-卡裝(10入) 1S L", price: "120/卡", cost: "1200", unit: "/ 打", notes: "", formula: "quantity * 1200", selections: [] },
            { id: 9, name: "四季舒敏護齒牙間刷I型-盒裝(100入) 4S 3S 1S M L", price: "1200/盒", cost: "960", unit: "/ 盒", notes: "", formula: "quantity * 960", selections: [] },
            { id: 10, name: "四季舒敏護齒牙間刷L型-卡裝(8入) 1S LL", price: "120/卡", cost: "1200", unit: "/ 打", notes: "", formula: "quantity * 1200", selections: [] },
            { id: 11, name: "四季剔牙樂Q彈齒縫清潔棒10入(卡裝)", price: "120/卡", cost: "1200", unit: "/ 打", notes: "", formula: "quantity * 1200", selections: [] },
            { id: 12, name: "四季3效合1牙周病用凝膠牙膏150g(72支/箱)", price: "220/支", cost: "1920", unit: "/ 打", notes: "", formula: "quantity * 1920", selections: [] },
            { id: 13, name: "四季3效合1牙周病用凝膠牙膏10g(200支/箱)", price: "25/支", cost: "3000/箱,216/打", unit: "", notes: "", formula: "quantity * 3000", selections: [] },
            { id: 14, name: "四季漱效口腔舒活凝露mouthwash 250ml", price: "300/瓶", cost: "2400", unit: "/ 打", notes: "24瓶4320", formula: "quantity * 200", selections: [] },
            { id: 15, name: "四季假牙雙層浸泡盒(100個/箱)", price: "75/個", cost: "5000/箱,660/打", unit: "", notes: "50個2500", formula: "quantity * 50", selections: [] },
            { id: 16, name: "四季假牙攜帶盒(100個/箱)", price: "40/個", cost: "2800/箱,360/打", unit: "", notes: "50個1400", formula: "quantity * 28", selections: [] },
            { id: 17, name: "四季假牙清潔刷", price: "85/支", cost: "720", unit: "/ 打", notes: "", formula: "quantity * 60", selections: [] },
            { id: 18, name: "四季冷熱敷袋(150個/箱)", price: "50/個", cost: "4800/箱,480/打", unit: "", notes: "", formula: "quantity * 32", selections: [] },
            { id: 19, name: "四季口腔照護旅行組(內含牙刷,牙膏,牙線-可客製)", price: "", cost: "專案價", unit: "", notes: "一個35元(敏刷),一個37元(晶炫)", formula: "special", selections: [] },
            { id: 20, name: "舒酸定專研亮白抗敏牙膏鎖白配方 100g", price: "190/支", cost: "1860", unit: "/ 打", notes: "", formula: "quantity * 155", selections: [] },
            { id: 21, name: "舒酸定專業抗敏護齦強化琺瑯質牙膏 100g 原味", price: "190/支", cost: "1860", unit: "/ 打", notes: "", formula: "quantity * 155", selections: [] },
            { id: 22, name: "舒酸定專業抗敏護齦牙膏100g", price: "170/支", cost: "1680", unit: "/ 打", notes: "", formula: "special", selections: [], options: ["原味", "美白"], optionPrices: { "原味": 140, "美白": 140 } },
            { id: 23, name: "舒酸定速效修護抗敏牙膏100g", price: "155/支", cost: "1500", unit: "/ 打", notes: "", formula: "special", selections: [], options: ["原味", "美白"], optionPrices: { "原味": 125, "美白": 125 } },
            { id: 24, name: "舒酸定專業修復抗敏牙膏(含Novamin) 100g", price: "170/支", cost: "1680", unit: "/ 打", notes: "", formula: "quantity * 140", selections: [] },
            { id: 25, name: "舒酸定專業抗敏修護琺瑯質牙膏100g 原味 美白", price: "170/支", cost: "1680", unit: "/ 打", notes: "", formula: "quantity * 140", selections: [] },
            { id: 26, name: "舒酸定強化琺瑯質兒童牙膏溫和薄荷 65g", price: "90/支", cost: "840", unit: "/ 打", notes: "", formula: "quantity * 70", selections: [] },
            { id: 27, name: "舒酸定長效抗敏牙膏120g", price: "145/130支", cost: "1380/1200", unit: "/ 打", notes: "紅:數*115 綠:數*100", formula: "special", selections: [], options: ["牙齦護理(紅)", "清涼薄荷(綠)"], optionPrices: { "牙齦護理(紅)": 115, "清涼薄荷(綠)": 100 } },
            { id: 28, name: "牙周適專業強韌護齦牙膏清新薄荷100g", price: "185/支", cost: "1740", unit: "/ 打", notes: "", formula: "quantity * 145", selections: [] },
            { id: 29, name: "牙周適牙齦護理牙膏90g", price: "155/支", cost: "1500", unit: "/ 打", notes: "", formula: "special", selections: [], options: ["經典配方", "草本修護"], optionPrices: { "經典配方": 125, "草本修護": 125 } },
            { id: 30, name: "牙周適固齒護齦牙膏80g", price: "145/支", cost: "1380", unit: "/ 打", notes: "", formula: "special", selections: [], options: ["高效清新", "亮白"], optionPrices: { "高效清新": 115, "亮白": 115 } },
            { id: 31, name: "牙周適牙齦護理漱口水 500ml", price: "185/瓶", cost: "1800", unit: "/ 打", notes: "7+1: 1050", formula: "special", selections: [], options: ["極淨清新", "溫和薄荷"], optionPrices: { "極淨清新": 150, "溫和薄荷": 150 } },
            { id: 32, name: "保麗淨假牙粘著劑", price: "320/支", cost: "3240", unit: "/ 打", notes: "23+1:6210 24+2:6480", formula: "special", selections: [], options: ["60g清新薄荷", "70g無味"], optionPrices: { "60g清新薄荷": 270, "70g無味": 270 } },
            { id: 33, name: "保麗淨好穩固粘著劑70g", price: "350/支", cost: "3420", unit: "/ 打", notes: "23+1:6555 24+2:6840", formula: "special", selections: [], options: ["舒適護齦", "全方位密合"], optionPrices: { "舒適護齦": 285, "全方位密合": 285 } },
            { id: 34, name: "保麗淨假牙清潔錠36片", price: "175/盒", cost: "1680", unit: "/ 打", notes: "", formula: "special", selections: [], options: ["全口錠", "口腔護具錠"], optionPrices: { "全口錠": 140, "口腔護具錠": 140 } },
            { id: 35, name: "舒酸定抗敏超軟毛牙刷2+1入", price: "165/卡", cost: "1620", unit: "/ 打", notes: "11+1: 1485", formula: "quantity * 135", selections: [] },
            { id: 36, name: "歐可林Oclean 智能聲波電動牙刷 旗鑑版 超靜音 Elite", price: "", cost: "2400", unit: "/ 組", notes: "", formula: "quantity * 2400", selections: [] },
            { id: 37, name: "歐可林Oclean 智能聲波電動牙刷 青春時尚版 Flow", price: "", cost: "1100", unit: "/ 組", notes: "", formula: "quantity * 1100", selections: [] },
            { id: 38, name: "歐可林Oclean 智能聲波電動牙刷兒童版 超靜音 Kids", price: "", cost: "1400", unit: "/ 組", notes: "", formula: "quantity * 1400", selections: [] },
            { id: 39, name: "歐可林Oclean 智能繽果沖牙機 攜帶型 W10", price: "", cost: "1900", unit: "/ 組", notes: "", formula: "quantity * 1900", selections: [] },
            { id: 40, name: "歐可林Oclean 智能活氧氣動沖牙機 攜帶型 A10", price: "", cost: "2180", unit: "/ 組", notes: "", formula: "quantity * 2180", selections: [] }
        ];

        // 業務員選項
        const salespersons = ["王慧玲", "張景婷"];

        // 客戶發貨單數據管理
        let clients = [];
        let activeClientId = 0;
        let clientCounter = 1;
        let isLocked = false;
        let firstSalespersonSelected = ""; // 記錄第一個分頁選擇的業務員
        let isFirstSalespersonSelected = false; // 是否已選擇第一個業務員

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 嘗試從本地儲存加載數據
            loadFromLocalStorage();
            
            // 如果沒有數據，創建第一個客戶
            if (clients.length === 0) {
                createNewClient();
            }
            
            // 添加事件監聽器
            document.getElementById('add-tab').addEventListener('click', function() {
                if (!isLocked) {
                    createNewClient();
                }
            });
            
            document.getElementById('save-page').addEventListener('click', saveToLocalStorage);
            document.getElementById('download-csv').addEventListener('click', downloadCSV);
            document.getElementById('lock-page').addEventListener('click', lockPage);
            document.getElementById('unlock-page').addEventListener('click', unlockPage);
            document.getElementById('clear-all').addEventListener('click', showClearAllModal);
            document.getElementById('clear-current').addEventListener('click', function() {
                if (!isLocked) {
                    showClearClientModal(activeClientId);
                }
            });
            
            // 更新客戶計數
            document.getElementById('client-count').textContent = clients.length;
        });

        // 創建新客戶
        function createNewClient() {
            const clientId = clientCounter++;
            const clientName = `客戶 ${clientId}`;
            
            // 創建客戶對象
            const client = {
                id: clientId,
                name: clientName,
                invoiceNumber: "", // 改為空值，讓用戶自己輸入
                clientData: {
                    name: '',
                    phone: '',
                    address: ''
                },
                date: {
                    year: new Date().getFullYear(),
                    month: new Date().getMonth() + 1,
                    day: new Date().getDate()
                },
                salesperson: isFirstSalespersonSelected ? firstSalespersonSelected : "", // 如果已有第一個業務員選擇，則使用它
                products: JSON.parse(JSON.stringify(products)), // 深拷貝產品數據
                delivery: 'sales' // 預設為業務員送貨
            };
            
            // 初始化產品數據
            client.products.forEach(product => {
                product.quantity = 0;
                product.gift = 0;
                product.amount = 0;
                // 初始化選項狀態
                product.selections = [];
                // 初始化多選項數量、搭贈和金額
                if (product.options) {
                    product.optionQuantities = {};
                    product.optionGifts = {};
                    product.optionAmounts = {};
                    product.options.forEach(option => {
                        product.optionQuantities[option] = 0;
                        product.optionGifts[option] = 0;
                        product.optionAmounts[option] = 0;
                    });
                }
            });
            
            // 添加到客戶列表
            clients.push(client);
            
            // 更新客戶計數
            document.getElementById('client-count').textContent = clients.length;
            
            // 創建分頁標籤
            createTab(client);
            
            // 創建發貨單內容
            createInvoiceContent(client);
            
            // 激活新客戶
            switchClient(clientId);
            
            return client;
        }

        // 生成發貨單號
        function generateInvoiceNumber() {
            const today = new Date();
            return "DM" + today.getFullYear() + 
                   (today.getMonth()+1).toString().padStart(2, '0') + 
                   Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        }

        // 創建分頁標籤
        function createTab(client) {
            const tabsHeader = document.getElementById('tabs-header');
            
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.clientId = client.id;
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'tab-name-text';
            nameSpan.dataset.clientId = client.id;
            nameSpan.textContent = client.name || `客戶 ${client.id}`;
            
            // 點擊標籤切換客戶
            tab.addEventListener('click', function(e) {
                if (!e.target.classList.contains('tab-close')) {
                    switchClient(client.id);
                }
            });
            
            // 關閉按鈕
            const closeSpan = document.createElement('span');
            closeSpan.className = 'tab-close';
            closeSpan.innerHTML = '✕';
            closeSpan.title = '關閉此客戶';
            
            closeSpan.addEventListener('click', function(e) {
                e.stopPropagation();
                if (isLocked) {
                    alert('頁面已鎖定，無法關閉分頁');
                    return;
                }
                
                if (clients.length > 1) {
                    showCloseTabModal(client.id);
                } else {
                    alert('至少需要保留一個客戶分頁');
                }
            });
            
            tab.appendChild(nameSpan);
            tab.appendChild(closeSpan);
            tabsHeader.appendChild(tab);
            
            // 更新分頁名稱
            updateTabName(client.id);
        }

        // 更新分頁名稱
        function updateTabName(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const tab = document.querySelector(`.tab[data-client-id="${clientId}"] .tab-name-text`);
            if (tab) {
                // 讀取客戶名稱輸入框的值，如果沒有則使用預設名稱
                const clientNameInput = document.getElementById(`client-name-${clientId}`);
                if (clientNameInput && clientNameInput.value.trim()) {
                    tab.textContent = clientNameInput.value.trim();
                    client.name = clientNameInput.value.trim();
                } else {
                    tab.textContent = `客戶 ${clientId}`;
                    client.name = `客戶 ${clientId}`;
                }
            }
        }

        // 創建發貨單內容
        function createInvoiceContent(client) {
            const invoicesContainer = document.getElementById('invoices-container');
            
            const invoiceDiv = document.createElement('div');
            invoiceDiv.className = 'invoice-container';
            invoiceDiv.id = `invoice-${client.id}`;
            invoiceDiv.dataset.clientId = client.id;
            
            // 格式化日期顯示
            const formattedDate = `${client.date.year}/${client.date.month}/${client.date.day}`;
            
            // 判斷是否要顯示下拉選單還是只顯示業務員名稱
            let salespersonControl;
            if (!isFirstSalespersonSelected && client.id === 1) {
                // 第一個分頁且尚未選擇業務員，顯示下拉選單
                salespersonControl = `
                    <select class="salesperson-select" id="salesperson-${client.id}">
                        <option value="">請選擇業務員</option>
                        ${salespersons.map(person => `<option value="${person}" ${client.salesperson === person ? 'selected' : ''}>${person}</option>`).join('')}
                    </select>
                `;
            } else if (isFirstSalespersonSelected && firstSalespersonSelected) {
                // 已選擇第一個業務員，只顯示業務員名稱
                salespersonControl = `<span class="salesperson-display">${firstSalespersonSelected}</span>`;
            } else {
                // 尚未選擇業務員，顯示下拉選單（第一個分頁）
                salespersonControl = `
                    <select class="salesperson-select" id="salesperson-${client.id}">
                        <option value="">請選擇業務員</option>
                        ${salespersons.map(person => `<option value="${person}" ${client.salesperson === person ? 'selected' : ''}>${person}</option>`).join('')}
                    </select>
                `;
            }
            
            // 發貨單HTML結構
            invoiceDiv.innerHTML = `
                <!-- 標題區 -->
                <div class="header">
                    <div style="height: 15px;"></div>
                    <div style="text-align: center; margin-bottom: 3px;">
                        <div class="company-name">丹美股份有限公司</div>
                    </div>
                    <div style="height: 8px;"></div>
                    <div class="invoice-title">
                        <div class="invoice-title-wrapper">
                            ${isFirstSalespersonSelected && firstSalespersonSelected ? `<span class="salesperson-title">${firstSalespersonSelected}</span>` : ''}
                            <div class="invoice-title-text">發貨單</div>
                        </div>
                    </div>
                    <div class="invoice-number">
                        右上角紅色字體單號: <input type="text" class="info-input" style="width: 110px; text-align: center;" id="invoice-number-${client.id}" value="${client.invoiceNumber}" placeholder="請輸入單號">
                    </div>
                </div>
               
                <!-- 客戶與訂單資訊 -->
                <div class="info-section">
                    <div class="client-info">
                        <div class="info-row">
                            <div class="info-label">業務員:</div>
                            ${salespersonControl}
                        </div>
                        <div class="info-row">
                            <div class="info-label">客戶名稱:</div>
                            <input type="text" class="info-input" id="client-name-${client.id}" value="${client.clientData.name}">
                        </div>
                        <div class="info-row">
                            <div class="info-label">電話:</div>
                            <input type="text" class="info-input" id="client-phone-${client.id}" value="${client.clientData.phone}">
                        </div>
                        <div class="info-row">
                            <div class="info-label">地址:</div>
                            <input type="text" class="info-input" id="client-address-${client.id}" value="${client.clientData.address}">
                        </div>
                    </div>
                   
                    <div class="order-info">
                        <div class="info-row" style="justify-content: flex-end;">
                            <div class="info-label">日期:</div>
                            <div class="date-inputs">
                                <input type="number" class="date-input" id="year-${client.id}" min="2023" max="2030" value="${client.date.year}" style="width: 60px;">
                                <span class="date-label">年</span>
                                <input type="number" class="date-input month-input" id="month-${client.id}" min="1" max="12" value="${client.date.month}">
                                <span class="date-label">月</span>
                                <input type="number" class="date-input day-input" id="day-${client.id}" min="1" max="31" value="${client.date.day}">
                                <span class="date-label">日</span>
                            </div>
                        </div>
                        <div class="info-row" style="justify-content: flex-end;">
                            <div class="info-label">訂貨專線:</div>
                            <div style="margin-left: 5px; font-size: 12px;">(02)27864899 / 0800213103</div>
                        </div>
                        <div class="info-row" style="justify-content: flex-end;">
                            <div class="info-label">傳真:</div>
                            <div style="margin-left: 5px; font-size: 12px;">(02)27862120</div>
                        </div>
                    </div>
                </div>
               
                <!-- 產品表格 -->
                <table class="products-table" id="products-table-${client.id}">
                    <thead>
                        <tr>
                            <th width="40">項次</th>
                            <th class="product-name">產品名稱/規格</th>
                            <th class="price-col">建議售價</th>
                            <th class="cost-col">進價</th>
                            <th class="unit-col">單位</th>
                            <th class="quantity-col">數量</th>
                            <th class="gift-col">搭贈</th>
                            <th class="amount-col">金額</th>
                            <th class="notes-col">備註</th>
                        </tr>
                    </thead>
                    <tbody id="products-body-${client.id}">
                        <!-- 產品將由JavaScript動態生成 -->
                    </tbody>
                </table>
               
                <!-- 總計區 -->
                <div class="total-section">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td width="30%">*以上產品到或共計</td>
                            <td width="10%" style="text-align: center; font-weight: bold;" id="item-count-${client.id}">0 項</td>
                            <td width="20%" style="text-align: right;">總訂貨金額 $ :</td>
                            <td width="20%" style="text-align: center; font-weight: bold; color: #c0392b;" id="total-amount-${client.id}">0</td>
                            <td width="20%" style="text-align: left;">元</td>
                        </tr>
                    </table>
                </div>
               
                <!-- 底部資訊 -->
                <div class="footer-section">
                    <div class="sales-info">
                        <div style="margin-bottom: 8px;">
                            <strong>業務簽名 :</strong> <span id="sales-signature-${client.id}" style="font-weight: bold; text-decoration: underline; margin-left: 5px;">${client.salesperson || '___________________'}</span>
                            <strong style="margin-left: 15px;">電話</strong> ___________________
                        </div>
                        <div class="warning-note">
                            若需辦理退換貨，需於出貨後3個月內完成
                        </div>
                    </div>
                   
                    <div class="delivery-info">
                        <div style="margin-bottom: 10px;">
                            <strong>送貨方式 :</strong>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="delivery-${client.id}" value="sales" ${client.delivery === 'sales' ? 'checked' : ''}> 業務員
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="delivery-${client.id}" value="shipping" ${client.delivery === 'shipping' ? 'checked' : ''}> 貨運行
                                </label>
                            </div>
                        </div>
                        <div>
                            <strong>簽收者 / 日期</strong> ___________________ / <span id="receiver-date-${client.id}" style="text-decoration: underline;">${formattedDate}</span>
                        </div>
                    </div>
                </div>
               
                <!-- 按鈕區 - 移除計算總金額按鈕 -->
                <div class="button-group">
                    <!-- 按鈕已移到上方控制欄 -->
                </div>
               
                <div class="warning-note">
                    注意：部分產品價格根據規格不同，請參考備註欄位。特殊促銷組合的金額計算方式請參照備註說明。
                </div>
            `;
            
            invoicesContainer.appendChild(invoiceDiv);
            
            // 為客戶生成產品表格
            generateProductsTableForClient(client.id);
            
            // 為客戶添加事件監聽器
            setupEventListenersForClient(client.id);
            
            // 計算初始總金額
            updateTotalAndItemCountForClient(client.id);
            
            // 如果頁面鎖定，應用鎖定樣式
            if (isLocked) {
                applyLockStyle();
            }
        }

        // 為客戶生成產品表格
        function generateProductsTableForClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const tbody = document.getElementById(`products-body-${clientId}`);
            tbody.innerHTML = '';
           
            client.products.forEach(product => {
                const row = document.createElement('tr');
                
                // 解析產品名稱 - 根據產品ID決定顯示方式
                let processedName = '';
                
                // 多選項產品
                if (product.id === 2 || product.id === 22 || product.id === 23 || product.id === 27 || 
                    product.id === 29 || product.id === 30 || product.id === 31 || product.id === 32 || 
                    product.id === 33 || product.id === 34) {
                    
                    // 在產品名稱欄位顯示主名稱和每個選項
                    processedName = `<div class="product-main-name">${product.name}</div>`;
                    
                    // 為每個選項創建勾選框和標籤
                    if (product.options && product.options.length > 0) {
                        product.options.forEach(option => {
                            const isSelected = product.selections && product.selections.includes(option);
                            processedName += `
                                <div class="product-option-checkbox">
                                    <span class="custom-checkbox ${isSelected ? 'checked' : ''}" 
                                          data-product-id="${product.id}" 
                                          data-client-id="${clientId}" 
                                          data-option="${option}" 
                                          data-type="checkbox"></span>
                                    <span class="option-label-small">${option}</span>
                                </div>
                            `;
                        });
                    }
                } else {
                    // 一般產品，只顯示名稱和方框勾選
                    processedName = product.name.replace(/□/g, '<span class="custom-checkbox" data-product-id="' + product.id + '" data-client-id="' + clientId + '" data-type="checkbox"></span>');
                }
                
                // 處理備註欄位，將促銷組合轉換為按鈕
                let notesHTML = '';
                
                // 根據產品ID添加不同的促銷按鈕
                if (product.id === 2) { // 史丹氟氟錠
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="2" data-promo-type="combo-option" data-quantity="36" data-gift="6" data-amount="7200" data-option="0.25mg">0.25mg:36+6:7200</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="2" data-promo-type="combo-option" data-quantity="36" data-gift="6" data-amount="10080" data-option="1mg">1mg:36+6:10080</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="2" data-promo-type="combo-option" data-quantity="120" data-gift="0" data-amount="19800" data-option="0.25mg">0.25mg:120:19800</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="2" data-promo-type="combo-option" data-quantity="120" data-gift="0" data-amount="27600" data-option="1mg">1mg120:27600</button>';
                    notesHTML += '</div>';
                } else if (product.id === 5) { // 四季敏感牙專用超軟毛牙刷2入/卡(12卡/盒)
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="5" data-promo-type="combo" data-quantity="4" data-gift="1" data-amount="3600">4+1打 3600</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="5" data-promo-type="combo" data-quantity="15" data-gift="5" data-amount="13500">15+5打 13500</button>';
                    notesHTML += '</div>';
                } else if (product.id === 7) { // 四季超氟淨寬扁高效能牙線50M
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="7" data-promo-type="combo" data-quantity="2" data-gift="0" data-amount="1440">新客戶兩打1440</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="7" data-promo-type="combo" data-quantity="4" data-gift="1" data-amount="3600">舊客戶4+1打3600</button>';
                    notesHTML += '</div>';
                } else if (product.id === 14) { // 四季漱效口腔舒活凝露mouthwash 250ml
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="14" data-promo-type="combo" data-quantity="24" data-gift="0" data-amount="4320">24瓶4320</button>';
                    notesHTML += '</div>';
                } else if (product.id === 15) { // 四季假牙雙層浸泡盒(100個/箱)
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="15" data-promo-type="combo" data-quantity="50" data-gift="0" data-amount="2500">50個2500</button>';
                    notesHTML += '</div>';
                } else if (product.id === 16) { // 四季假牙攜帶盒(100個/箱)
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="16" data-promo-type="combo" data-quantity="50" data-gift="0" data-amount="1400">50個1400</button>';
                    notesHTML += '</div>';
                } else if (product.id === 19) { // 四季口腔照護旅行組(內含牙刷,牙膏,牙線-可客製)
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="19" data-promo-type="multiply" data-price="35" data-amount="0">一個35元(敏刷)</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="19" data-promo-type="multiply" data-price="37" data-amount="0">一個37元(晶炫)</button>';
                    notesHTML += '</div>';
                } else if (product.id === 27) { // 舒酸定長效抗敏牙膏120g
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="27" data-promo-type="multiply-option" data-price="115" data-option="牙齦護理(紅)">紅:數*115</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="27" data-promo-type="multiply-option" data-price="100" data-option="清涼薄荷(綠)">綠:數*100</button>';
                    notesHTML += '</div>';
                } else if (product.id === 31) { // 牙周適牙齦護理漱口水 500ml
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="31" data-promo-type="combo-option" data-quantity="7" data-gift="1" data-amount="1050">7+1: 1050</button>';
                    notesHTML += '</div>';
                } else if (product.id === 32) { // 保麗淨假牙粘著劑
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="32" data-promo-type="combo-option" data-quantity="23" data-gift="1" data-amount="6210">23+1:6210</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="32" data-promo-type="combo-option" data-quantity="24" data-gift="2" data-amount="6480">24+2:6480</button>';
                    notesHTML += '</div>';
                } else if (product.id === 33) { // 保麗淨好穩固粘著劑70g
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="33" data-promo-type="combo-option" data-quantity="23" data-gift="1" data-amount="6555">23+1:6555</button>';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="33" data-promo-type="combo-option" data-quantity="24" data-gift="2" data-amount="6840">24+2:6840</button>';
                    notesHTML += '</div>';
                } else if (product.id === 35) { // 舒酸定抗敏超軟毛牙刷2+1入
                    notesHTML = '<div style="display: flex; flex-direction: column; gap: 2px;">';
                    notesHTML += '<button class="promo-button" data-client-id="' + clientId + '" data-product-id="35" data-promo-type="combo" data-quantity="11" data-gift="1" data-amount="1485">11+1: 1485</button>';
                    notesHTML += '</div>';
                } else {
                    notesHTML = product.notes;
                }
                
                // 對於多選項產品，我們修改表格結構
                if (product.id === 2 || product.id === 22 || product.id === 23 || product.id === 27 || 
                    product.id === 29 || product.id === 30 || product.id === 31 || product.id === 32 || 
                    product.id === 33 || product.id === 34) {
                    // 創建數量欄位的輸入框容器
                    let quantityHTML = '<div class="quantity-options-container">';
                    
                    if (product.options && product.options.length > 0) {
                        product.options.forEach(option => {
                            const quantity = product.optionQuantities && product.optionQuantities[option] ? product.optionQuantities[option] : 0;
                            // 縮短文字顯示
                            let displayOption = option;
                            if (option === "牙齦護理(紅)") displayOption = "紅";
                            if (option === "清涼薄荷(綠)") displayOption = "綠";
                            
                            quantityHTML += `
                                <div class="quantity-option-row">
                                    <span class="option-label">${displayOption}:</span>
                                    <input type="number" class="option-quantity-in-quantity-col" min="0" value="${quantity}" 
                                           data-product-id="${product.id}" 
                                           data-client-id="${clientId}" 
                                           data-option="${option}" 
                                           placeholder="0">
                                </div>
                            `;
                        });
                    }
                    quantityHTML += '</div>';
                    
                    // 創建搭贈欄位的輸入框容器
                    let giftHTML = '<div class="gift-options-container">';
                    
                    if (product.options && product.options.length > 0) {
                        product.options.forEach(option => {
                            const gift = product.optionGifts && product.optionGifts[option] ? product.optionGifts[option] : 0;
                            // 縮短文字顯示
                            let displayOption = option;
                            if (option === "牙齦護理(紅)") displayOption = "紅";
                            if (option === "清涼薄荷(綠)") displayOption = "綠";
                            
                            giftHTML += `
                                <div class="gift-option-row">
                                    <span class="option-label">${displayOption}:</span>
                                    <input type="number" class="option-gift-in-gift-col" min="0" value="${gift}" 
                                           data-product-id="${product.id}" 
                                           data-client-id="${clientId}" 
                                           data-option="${option}" 
                                           placeholder="0">
                                </div>
                            `;
                        });
                    }
                    giftHTML += '</div>';
                    
                    // 創建金額欄位的顯示容器
                    let amountHTML = '<div class="amount-options-container">';
                    
                    if (product.options && product.options.length > 0) {
                        product.options.forEach(option => {
                            const optionAmount = product.optionAmounts && product.optionAmounts[option] ? product.optionAmounts[option] : 0;
                            // 縮短文字顯示
                            let displayOption = option;
                            if (option === "牙齦護理(紅)") displayOption = "紅";
                            if (option === "清涼薄荷(綠)") displayOption = "綠";
                            
                            amountHTML += `
                                <div class="amount-option-row">
                                    <span class="option-label">${displayOption}:</span>
                                    <span class="option-amount-in-amount-col" data-product-id="${product.id}" data-client-id="${clientId}" data-option="${option}">
                                        ${optionAmount > 0 ? '$' + optionAmount.toLocaleString() : ''}
                                    </span>
                                </div>
                            `;
                        });
                        
                        // 添加總計行
                        const totalAmount = product.amount || 0;
                        amountHTML += `
                            <div class="amount-total-row" data-product-id="${product.id}" data-client-id="${clientId}">
                                總計: ${totalAmount > 0 ? '$' + totalAmount.toLocaleString() : '$0'}
                            </div>
                        `;
                    }
                    amountHTML += '</div>';
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td class="product-name">${processedName}</td>
                        <td class="price-col">${product.price}</td>
                        <td class="cost-col">${product.cost}</td>
                        <td class="unit-col">${product.unit}</td>
                        <td class="quantity-col">
                            ${quantityHTML}
                        </td>
                        <td class="gift-col">
                            ${giftHTML}
                        </td>
                        <td class="amount-col">
                            ${amountHTML}
                        </td>
                        <td class="notes-col">${notesHTML}</td>
                    `;
                } else {
                    // 標準產品
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td class="product-name">${processedName}</td>
                        <td class="price-col">${product.price}</td>
                        <td class="cost-col">${product.cost}</td>
                        <td class="unit-col">${product.unit}</td>
                        <td class="quantity-col">
                            <input type="number" class="number-input" min="0" value="${product.quantity || 0}" data-id="${product.id}" data-client-id="${clientId}" data-formula="${product.formula}">
                        </td>
                        <td class="gift-col">
                            <input type="number" class="number-input" min="0" value="${product.gift || 0}" data-id="${product.id}" data-client-id="${clientId}">
                        </td>
                        <td class="amount-col">
                            <div style="font-weight: bold; color: #c0392b;" data-id="${product.id}" data-client-id="${clientId}">
                                ${product.amount ? '$' + product.amount.toLocaleString() : '$0'}
                            </div>
                        </td>
                        <td class="notes-col">${notesHTML}</td>
                    `;
                }
                
                tbody.appendChild(row);
               
                // 為標準輸入框添加事件監聽器
                if (!(product.id === 2 || product.id === 22 || product.id === 23 || product.id === 27 || 
                      product.id === 29 || product.id === 30 || product.id === 31 || product.id === 32 || 
                      product.id === 33 || product.id === 34)) {
                    const quantityInput = row.querySelector('.quantity-col input');
                    quantityInput.addEventListener('input', function() {
                        calculateProductForClient(product.id, clientId);
                        updateTotalAndItemCountForClient(clientId);
                    });
                    
                    const giftInput = row.querySelector('.gift-col input');
                    giftInput.addEventListener('input', function() {
                        updateGiftForClient(product.id, clientId, this.value);
                    });
                }
                
                // 為多選項產品的數量輸入框添加事件監聽器（在數量欄位中）
                if (product.id === 2 || product.id === 22 || product.id === 23 || product.id === 27 || 
                    product.id === 29 || product.id === 30 || product.id === 31 || product.id === 32 || 
                    product.id === 33 || product.id === 34) {
                    // 數量輸入框事件
                    const optionQuantityInputs = row.querySelectorAll('.option-quantity-in-quantity-col');
                    optionQuantityInputs.forEach(input => {
                        input.addEventListener('input', function() {
                            const productId = parseInt(this.getAttribute('data-product-id'));
                            const clientId = parseInt(this.getAttribute('data-client-id'));
                            const option = this.getAttribute('data-option');
                            const quantity = parseInt(this.value) || 0;
                            
                            // 更新產品選項數量
                            const client = clients.find(c => c.id === clientId);
                            if (client) {
                                const prod = client.products.find(p => p.id === productId);
                                if (prod && prod.optionQuantities) {
                                    prod.optionQuantities[option] = quantity;
                                    
                                    // 自動勾選該選項
                                    if (quantity > 0 && !prod.selections.includes(option)) {
                                        prod.selections.push(option);
                                        
                                        // 更新勾選框顯示
                                        const checkbox = document.querySelector(`.custom-checkbox[data-product-id="${productId}"][data-client-id="${clientId}"][data-option="${option}"]`);
                                        if (checkbox) {
                                            checkbox.classList.add('checked');
                                        }
                                    } else if (quantity === 0 && prod.selections.includes(option)) {
                                        // 取消勾選
                                        prod.selections = prod.selections.filter(s => s !== option);
                                        
                                        // 更新勾選框顯示
                                        const checkbox = document.querySelector(`.custom-checkbox[data-product-id="${productId}"][data-client-id="${clientId}"][data-option="${option}"]`);
                                        if (checkbox) {
                                            checkbox.classList.remove('checked');
                                        }
                                    }
                                }
                            }
                            
                            // 重新計算金額
                            calculateProductForClient(productId, clientId);
                            updateTotalAndItemCountForClient(clientId);
                        });
                    });
                    
                    // 搭贈輸入框事件
                    const optionGiftInputs = row.querySelectorAll('.option-gift-in-gift-col');
                    optionGiftInputs.forEach(input => {
                        input.addEventListener('input', function() {
                            const productId = parseInt(this.getAttribute('data-product-id'));
                            const clientId = parseInt(this.getAttribute('data-client-id'));
                            const option = this.getAttribute('data-option');
                            const gift = parseInt(this.value) || 0;
                            
                            // 更新產品選項搭贈
                            const client = clients.find(c => c.id === clientId);
                            if (client) {
                                const prod = client.products.find(p => p.id === productId);
                                if (prod && prod.optionGifts) {
                                    prod.optionGifts[option] = gift;
                                }
                            }
                        });
                    });
                    
                    // 為勾選框添加事件監聽器
                    const checkboxes = row.querySelectorAll('.custom-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('click', function() {
                            if (isLocked) return;
                            
                            const productId = this.getAttribute('data-product-id');
                            const clientId = this.getAttribute('data-client-id');
                            const option = this.getAttribute('data-option');
                            
                            // 更新產品選擇狀態
                            const client = clients.find(c => c.id === parseInt(clientId));
                            if (client) {
                                const prod = client.products.find(p => p.id === parseInt(productId));
                                if (prod) {
                                    if (this.classList.contains('checked')) {
                                        // 取消勾選
                                        this.classList.remove('checked');
                                        if (option) {
                                            prod.selections = prod.selections.filter(s => s !== option);
                                            // 清空數量
                                            if (prod.optionQuantities) {
                                                prod.optionQuantities[option] = 0;
                                            }
                                            // 清空輸入框
                                            const input = document.querySelector(`.option-quantity-in-quantity-col[data-product-id="${productId}"][data-client-id="${clientId}"][data-option="${option}"]`);
                                            if (input) {
                                                input.value = 0;
                                            }
                                        }
                                    } else {
                                        // 勾選
                                        this.classList.add('checked');
                                        if (option && !prod.selections.includes(option)) {
                                            prod.selections.push(option);
                                            // 設置數量為1
                                            if (prod.optionQuantities) {
                                                prod.optionQuantities[option] = 1;
                                            }
                                            // 設置輸入框
                                            const input = document.querySelector(`.option-quantity-in-quantity-col[data-product-id="${productId}"][data-client-id="${clientId}"][data-option="${option}"]`);
                                            if (input) {
                                                input.value = 1;
                                            }
                                        }
                                    }
                                    
                                    // 重新計算金額
                                    calculateProductForClient(productId, clientId);
                                    updateTotalAndItemCountForClient(clientId);
                                }
                            }
                        });
                    });
                }
                
                // 為促銷按鈕添加事件監聽器
                const promoButtons = row.querySelectorAll('.promo-button');
                promoButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (isLocked) return;
                        
                        const productId = parseInt(this.getAttribute('data-product-id'));
                        const clientId = parseInt(this.getAttribute('data-client-id'));
                        const promoType = this.getAttribute('data-promo-type');
                        const promoName = this.textContent;
                        
                        // 根據促銷類型調用不同的彈出視窗
                        if (promoType === 'combo') {
                            const baseQuantity = parseInt(this.getAttribute('data-quantity'));
                            const baseGift = parseInt(this.getAttribute('data-gift'));
                            const baseAmount = parseInt(this.getAttribute('data-amount'));
                            
                            showComboModal(clientId, productId, baseQuantity, baseGift, baseAmount, promoName);
                        } else if (promoType === 'multiply') {
                            const price = parseInt(this.getAttribute('data-price'));
                            showMultiplyModal(clientId, productId, price, promoName);
                        } else if (promoType === 'multiply-option') {
                            const price = parseInt(this.getAttribute('data-price'));
                            const option = this.getAttribute('data-option');
                            showMultiplyOptionModal(clientId, productId, price, promoName, option);
                        } else if (promoType === 'combo-option') {
                            const baseQuantity = parseInt(this.getAttribute('data-quantity'));
                            const baseGift = parseInt(this.getAttribute('data-gift'));
                            const baseAmount = parseInt(this.getAttribute('data-amount'));
                            const option = this.getAttribute('data-option');
                            
                            showComboOptionModal(clientId, productId, baseQuantity, baseGift, baseAmount, promoName, option);
                        }
                    });
                });
            });
        }

        // 顯示組合促銷彈出視窗（一般產品）
        function showComboModal(clientId, productId, baseQuantity, baseGift, baseAmount, promoName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay promo-modal';
            
            let modalContent = `
                <div class="modal">
                    <h3>選擇促銷組合組數</h3>
                    <div class="promo-option">
                        <div class="promo-title">${promoName}</div>
                        <div class="promo-desc">每組：正品 ${baseQuantity}，搭贈 ${baseGift}，金額 ${baseAmount} 元</div>
                        <div class="group-input">
                            <label>組數：</label>
                            <input type="number" id="group-count-${clientId}-${productId}" min="1" value="1" style="width: 80px; padding: 5px;">
                        </div>
                        <div class="total-calc" id="total-calc-${clientId}-${productId}">
                            總計：正品 ${baseQuantity}，搭贈 ${baseGift}，金額 ${baseAmount} 元
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">取消</button>
                        <button class="modal-btn modal-confirm">確定</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // 取得輸入框和計算顯示元素
            const groupInput = document.getElementById(`group-count-${clientId}-${productId}`);
            const totalCalc = document.getElementById(`total-calc-${clientId}-${productId}`);
            
            // 更新計算顯示
            function updateCalc() {
                const groupCount = parseInt(groupInput.value) || 1;
                const totalQuantity = baseQuantity * groupCount;
                const totalGift = baseGift * groupCount;
                const totalAmount = baseAmount * groupCount;
                
                totalCalc.textContent = `總計：正品 ${totalQuantity}，搭贈 ${totalGift}，金額 ${totalAmount} 元`;
            }
            
            // 初始計算
            updateCalc();
            
            // 監聽輸入變化
            groupInput.addEventListener('input', updateCalc);
            groupInput.addEventListener('change', updateCalc);
            
            // 確定按鈕事件
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                const groupCount = parseInt(groupInput.value) || 1;
                const totalQuantity = baseQuantity * groupCount;
                const totalGift = baseGift * groupCount;
                const totalAmount = baseAmount * groupCount;
                
                // 更新客戶產品數據
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const prod = client.products.find(p => p.id === productId);
                    if (prod) {
                        prod.quantity = totalQuantity;
                        prod.gift = totalGift;
                        prod.amount = totalAmount;
                        
                        // 更新輸入框
                        const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                        if (row) {
                            const qtyInput = row.querySelector('.quantity-col input');
                            if (qtyInput) qtyInput.value = totalQuantity;
                            
                            const giftInput = row.querySelector('.gift-col input');
                            if (giftInput) giftInput.value = totalGift;
                            
                            const amountDiv = row.querySelector('.amount-col div');
                            if (amountDiv) amountDiv.textContent = '$' + totalAmount.toLocaleString();
                        }
                        
                        // 更新總計
                        updateTotalAndItemCountForClient(clientId);
                    }
                }
                
                document.body.removeChild(modal);
            });
            
            // 取消按鈕事件
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 按ESC鍵關閉
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });
            
            // 點擊背景關閉
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 聚焦到輸入框
            groupInput.focus();
            groupInput.select();
        }

        // 顯示組合促銷彈出視窗（多選項產品 - 針對特定選項）
        function showComboOptionModal(clientId, productId, baseQuantity, baseGift, baseAmount, promoName, option) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay promo-modal';
            
            let modalContent = `
                <div class="modal">
                    <h3>選擇促銷組合組數</h3>
                    <div class="promo-option">
                        <div class="promo-title">${promoName}</div>
                        <div class="promo-desc">${option} 每組：正品 ${baseQuantity}，搭贈 ${baseGift}，金額 ${baseAmount} 元</div>
                        <div class="group-input">
                            <label>組數：</label>
                            <input type="number" id="group-count-${clientId}-${productId}-${option}" min="1" value="1" style="width: 80px; padding: 5px;">
                        </div>
                        <div class="total-calc" id="total-calc-${clientId}-${productId}">
                            總計：正品 ${baseQuantity}，搭贈 ${baseGift}，金額 ${baseAmount} 元
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">取消</button>
                        <button class="modal-btn modal-confirm">確定</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // 取得輸入框和計算顯示元素
            const groupInput = document.getElementById(`group-count-${clientId}-${productId}-${option}`);
            const totalCalc = document.getElementById(`total-calc-${clientId}-${productId}`);
            
            // 更新計算顯示
            function updateCalc() {
                const groupCount = parseInt(groupInput.value) || 1;
                const totalQuantity = baseQuantity * groupCount;
                const totalGift = baseGift * groupCount;
                const totalAmount = baseAmount * groupCount;
                
                totalCalc.textContent = `總計：正品 ${totalQuantity}，搭贈 ${totalGift}，金額 ${totalAmount} 元`;
            }
            
            // 初始計算
            updateCalc();
            
            // 監聽輸入變化
            groupInput.addEventListener('input', updateCalc);
            groupInput.addEventListener('change', updateCalc);
            
            // 確定按鈕事件
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                const groupCount = parseInt(groupInput.value) || 1;
                const totalQuantity = baseQuantity * groupCount;
                const totalGift = baseGift * groupCount;
                const totalAmount = baseAmount * groupCount;
                
                // 更新客戶產品數據
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const prod = client.products.find(p => p.id === productId);
                    if (prod) {
                        // 更新選項
                        prod.optionQuantities[option] = totalQuantity;
                        prod.optionGifts[option] = totalGift;
                        prod.optionAmounts[option] = totalAmount;
                        
                        // 確保選項被勾選
                        if (!prod.selections.includes(option)) {
                            prod.selections.push(option);
                        }
                        
                        // 更新界面
                        const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                        if (row) {
                            // 更新數量輸入框
                            const optionInput = row.querySelector(`.option-quantity-in-quantity-col[data-option="${option}"]`);
                            if (optionInput) {
                                optionInput.value = totalQuantity;
                            }
                            
                            // 更新搭贈輸入框
                            const giftInput = row.querySelector(`.option-gift-in-gift-col[data-option="${option}"]`);
                            if (giftInput) {
                                giftInput.value = totalGift;
                            }
                            
                            // 更新勾選框
                            const checkbox = row.querySelector(`.custom-checkbox[data-option="${option}"]`);
                            if (checkbox) {
                                checkbox.classList.add('checked');
                            }
                        }
                        
                        // 重新計算產品總金額
                        calculateProductForClient(productId, clientId);
                        updateTotalAndItemCountForClient(clientId);
                    }
                }
                
                document.body.removeChild(modal);
            });
            
            // 取消按鈕事件
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 按ESC鍵關閉
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });
            
            // 點擊背景關閉
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 聚焦到輸入框
            groupInput.focus();
            groupInput.select();
        }

        // 顯示乘法計算彈出視窗（一般產品）
        function showMultiplyModal(clientId, productId, price, promoName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay promo-modal';
            
            let modalContent = `
                <div class="modal">
                    <h3>輸入數量計算金額</h3>
                    <div class="promo-option">
                        <div class="promo-title">${promoName}</div>
                        <div class="promo-desc">單價：${price} 元</div>
                        <div class="group-input">
                            <label>數量：</label>
                            <input type="number" id="quantity-${clientId}-${productId}" min="1" value="1" style="width: 80px; padding: 5px;">
                        </div>
                        <div class="total-calc" id="total-calc-${clientId}-${productId}">
                            總計：1 × ${price} = ${price} 元
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">取消</button>
                        <button class="modal-btn modal-confirm">確定</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // 取得輸入框和計算顯示元素
            const quantityInput = document.getElementById(`quantity-${clientId}-${productId}`);
            const totalCalc = document.getElementById(`total-calc-${clientId}-${productId}`);
            
            // 更新計算顯示
            function updateCalc() {
                const quantity = parseInt(quantityInput.value) || 1;
                const totalAmount = quantity * price;
                
                totalCalc.textContent = `總計：${quantity} × ${price} = ${totalAmount} 元`;
            }
            
            // 初始計算
            updateCalc();
            
            // 監聽輸入變化
            quantityInput.addEventListener('input', updateCalc);
            quantityInput.addEventListener('change', updateCalc);
            
            // 確定按鈕事件
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                const quantity = parseInt(quantityInput.value) || 1;
                const totalAmount = quantity * price;
                
                // 更新客戶產品數據
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const prod = client.products.find(p => p.id === productId);
                    if (prod) {
                        prod.quantity = quantity;
                        prod.gift = 0;
                        prod.amount = totalAmount;
                        
                        // 更新輸入框
                        const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                        if (row) {
                            const qtyInput = row.querySelector('.quantity-col input');
                            if (qtyInput) qtyInput.value = quantity;
                            
                            const giftInput = row.querySelector('.gift-col input');
                            if (giftInput) giftInput.value = 0;
                            
                            const amountDiv = row.querySelector('.amount-col div');
                            if (amountDiv) amountDiv.textContent = '$' + totalAmount.toLocaleString();
                        }
                        
                        // 更新總計
                        updateTotalAndItemCountForClient(clientId);
                    }
                }
                
                document.body.removeChild(modal);
            });
            
            // 取消按鈕事件
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 按ESC鍵關閉
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });
            
            // 點擊背景關閉
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 聚焦到輸入框
            quantityInput.focus();
            quantityInput.select();
        }

        // 顯示乘法計算彈出視窗（多選項產品）
        function showMultiplyOptionModal(clientId, productId, price, promoName, option) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay promo-modal';
            
            let modalContent = `
                <div class="modal">
                    <h3>輸入數量計算金額</h3>
                    <div class="promo-option">
                        <div class="promo-title">${promoName}</div>
                        <div class="promo-desc">${option} 單價：${price} 元</div>
                        <div class="group-input">
                            <label>數量：</label>
                            <input type="number" id="quantity-${clientId}-${productId}-${option}" min="1" value="1" style="width: 80px; padding: 5px;">
                        </div>
                        <div class="total-calc" id="total-calc-${clientId}-${productId}">
                            總計：1 × ${price} = ${price} 元
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">取消</button>
                        <button class="modal-btn modal-confirm">確定</button>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // 取得輸入框和計算顯示元素
            const quantityInput = document.getElementById(`quantity-${clientId}-${productId}-${option}`);
            const totalCalc = document.getElementById(`total-calc-${clientId}-${productId}`);
            
            // 更新計算顯示
            function updateCalc() {
                const quantity = parseInt(quantityInput.value) || 1;
                const totalAmount = quantity * price;
                
                totalCalc.textContent = `總計：${quantity} × ${price} = ${totalAmount} 元`;
            }
            
            // 初始計算
            updateCalc();
            
            // 監聽輸入變化
            quantityInput.addEventListener('input', updateCalc);
            quantityInput.addEventListener('change', updateCalc);
            
            // 確定按鈕事件
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                const quantity = parseInt(quantityInput.value) || 1;
                const totalAmount = quantity * price;
                
                // 更新客戶產品數據
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const prod = client.products.find(p => p.id === productId);
                    if (prod) {
                        // 更新選項
                        prod.optionQuantities[option] = quantity;
                        prod.optionAmounts[option] = totalAmount;
                        
                        // 確保選項被勾選
                        if (!prod.selections.includes(option)) {
                            prod.selections.push(option);
                        }
                        
                        // 更新界面
                        const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                        if (row) {
                            const optionInput = row.querySelector(`.option-quantity-in-quantity-col[data-option="${option}"]`);
                            if (optionInput) {
                                optionInput.value = quantity;
                            }
                            
                            const checkbox = row.querySelector(`.custom-checkbox[data-option="${option}"]`);
                            if (checkbox) {
                                checkbox.classList.add('checked');
                            }
                        }
                        
                        // 重新計算產品總金額
                        calculateProductForClient(productId, clientId);
                        updateTotalAndItemCountForClient(clientId);
                    }
                }
                
                document.body.removeChild(modal);
            });
            
            // 取消按鈕事件
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 按ESC鍵關閉
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                }
            });
            
            // 點擊背景關閉
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 聚焦到輸入框
            quantityInput.focus();
            quantityInput.select();
        }

        // 為客戶計算單一產品金額
        function calculateProductForClient(productId, clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const product = client.products.find(p => p.id === productId);
           
            if (!product) return;
           
            let totalAmount = 0;
           
            // 特殊產品的計算
            if (product.formula === 'special') {
                // 多選項產品
                if (product.options && product.options.length > 0) {
                    // 計算每個選項的金額
                    product.options.forEach(option => {
                        if (product.selections && product.selections.includes(option) && 
                            product.optionQuantities && product.optionQuantities[option] > 0) {
                            
                            const quantity = product.optionQuantities[option] || 0;
                            const price = product.optionPrices[option] || 0;
                            const optionAmount = quantity * price;
                            
                            // 更新選項金額
                            product.optionAmounts[option] = optionAmount;
                            totalAmount += optionAmount;
                            
                            // 更新選項金額顯示
                            const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                            if (row) {
                                const optionAmountSpan = row.querySelector(`.option-amount-in-amount-col[data-option="${option}"]`);
                                if (optionAmountSpan) {
                                    optionAmountSpan.textContent = optionAmount > 0 ? '$' + optionAmount.toLocaleString() : '';
                                }
                            }
                        } else {
                            // 清除未選擇選項的金額
                            product.optionAmounts[option] = 0;
                            
                            // 更新選項金額顯示
                            const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                            if (row) {
                                const optionAmountSpan = row.querySelector(`.option-amount-in-amount-col[data-option="${option}"]`);
                                if (optionAmountSpan) {
                                    optionAmountSpan.textContent = '';
                                }
                            }
                        }
                    });
                    
                    // 更新產品總金額
                    product.amount = totalAmount;
                    
                    // 更新總計顯示
                    const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                    if (row) {
                        const totalAmountDiv = row.querySelector('.amount-total-row');
                        if (totalAmountDiv) {
                            totalAmountDiv.textContent = `總計: ${totalAmount > 0 ? '$' + totalAmount.toLocaleString() : '$0'}`;
                        }
                    }
                } else if (productId === 19) {
                    // 旅行組 - 專案價，需要使用者輸入
                    totalAmount = 0;
                    const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                    if (row) {
                        const amountDiv = row.querySelector('.amount-col div');
                        if (amountDiv) {
                            amountDiv.innerHTML = `<span style="color:#999;">專案價</span>`;
                        }
                    }
                    // 保存數量
                    product.amount = totalAmount;
                    return;
                }
            } else {
                // 一般產品的計算公式
                const quantity = product.quantity || 0;
                const formula = product.formula.replace('quantity', quantity);
                try {
                    totalAmount = eval(formula);
                } catch (e) {
                    console.error('計算錯誤:', e);
                    totalAmount = 0;
                }
                
                // 更新一般產品的金額顯示
                const row = document.querySelector(`#products-body-${clientId} tr:nth-child(${productId})`);
                if (row) {
                    const amountDiv = row.querySelector('.amount-col div');
                    if (amountDiv) {
                        amountDiv.textContent = '$' + totalAmount.toLocaleString();
                    }
                }
            }
           
            // 更新客戶產品數據中的金額
            product.amount = totalAmount;
        }

        // 更新搭贈數量
        function updateGiftForClient(productId, clientId, giftValue) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const product = client.products.find(p => p.id === productId);
            if (product) {
                product.gift = parseInt(giftValue) || 0;
            }
        }

        // 為客戶更新總金額和項次統計
        function updateTotalAndItemCountForClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            let total = 0;
            let itemCount = 0;
            
            // 統計所有產品的金額
            client.products.forEach(product => {
                if (product.amount && product.amount > 0) {
                    itemCount++;
                    total += product.amount || 0;
                }
            });
            
            // 更新顯示
            document.getElementById(`total-amount-${clientId}`).textContent = total.toLocaleString();
            document.getElementById(`item-count-${clientId}`).textContent = itemCount + ' 項';
        }

        // 為客戶清除所有輸入
        function clearClientData(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // 清除客戶資料（但不清除業務員，如果已選擇第一個業務員）
            client.clientData.name = '';
            client.clientData.phone = '';
            client.clientData.address = '';
            
            // 清除發貨單號（改為空值）
            client.invoiceNumber = "";
            
            // 重置日期為今天
            const today = new Date();
            client.date.year = today.getFullYear();
            client.date.month = today.getMonth() + 1;
            client.date.day = today.getDate();
            
            // 清除產品數量和選擇
            client.products.forEach(product => {
                product.quantity = 0;
                product.gift = 0;
                product.amount = 0;
                product.selections = [];
                
                // 清除多選項數量、搭贈
                if (product.options) {
                    product.optionQuantities = {};
                    product.optionGifts = {};
                    product.optionAmounts = {};
                    product.options.forEach(option => {
                        product.optionQuantities[option] = 0;
                        product.optionGifts[option] = 0;
                        product.optionAmounts[option] = 0;
                    });
                }
            });
            
            // 更新輸入框
            document.getElementById(`client-name-${clientId}`).value = '';
            document.getElementById(`client-phone-${clientId}`).value = '';
            document.getElementById(`client-address-${clientId}`).value = '';
            document.getElementById(`invoice-number-${clientId}`).value = '';
            
            // 不重置業務員選擇
            document.getElementById(`year-${clientId}`).value = client.date.year;
            document.getElementById(`month-${clientId}`).value = client.date.month;
            document.getElementById(`day-${clientId}`).value = client.date.day;
           
            // 清除產品數量輸入框
            const quantityInputs = document.querySelectorAll(`.quantity-col input[data-client-id="${clientId}"]`);
            quantityInputs.forEach(input => {
                input.value = 0;
            });
           
            const giftInputs = document.querySelectorAll(`.gift-col input[data-client-id="${clientId}"]`);
            giftInputs.forEach(input => {
                input.value = 0;
            });
           
            // 清除多選項數量輸入框
            const optionInputs = document.querySelectorAll(`.option-quantity-in-quantity-col[data-client-id="${clientId}"]`);
            optionInputs.forEach(input => {
                input.value = 0;
            });
            
            // 清除多選項搭贈輸入框
            const optionGiftInputs = document.querySelectorAll(`.option-gift-in-gift-col[data-client-id="${clientId}"]`);
            optionGiftInputs.forEach(input => {
                input.value = 0;
            });
           
            // 清除金額顯示
            const amountDivs = document.querySelectorAll(`.amount-col div[data-client-id="${clientId}"]`);
            amountDivs.forEach(div => {
                div.textContent = '$0';
            });
            
            // 清除多選項金額顯示
            const optionAmounts = document.querySelectorAll(`.option-amount-in-amount-col[data-client-id="${clientId}"]`);
            optionAmounts.forEach(span => {
                span.textContent = '';
            });
            
            // 清除多選項總計顯示
            const totalAmountRows = document.querySelectorAll(`.amount-total-row[data-client-id="${clientId}"]`);
            totalAmountRows.forEach(div => {
                div.textContent = '總計: $0';
            });
            
            // 清除選擇框
            const checkboxes = document.querySelectorAll(`.custom-checkbox[data-client-id="${clientId}"]`);
            checkboxes.forEach(checkbox => {
                checkbox.classList.remove('checked');
            });
            
            // 更新分頁名稱
            updateTabName(clientId);
            
            // 更新業務簽名顯示（保持業務員選擇）
            const signatureSpan = document.getElementById(`sales-signature-${clientId}`);
            if (signatureSpan) {
                signatureSpan.textContent = client.salesperson || '___________________';
            }
            
            // 更新簽收者日期
            updateReceiverDate(clientId);
            
            // 重新生成產品表格以清除選擇狀態
            generateProductsTableForClient(clientId);
            
            // 重新計算
            updateTotalAndItemCountForClient(clientId);
        }

        // 儲存到本地儲存
        function saveToLocalStorage() {
            const saveData = {
                clients: clients,
                clientCounter: clientCounter,
                activeClientId: activeClientId,
                firstSalespersonSelected: firstSalespersonSelected,
                isFirstSalespersonSelected: isFirstSalespersonSelected
            };
            
            localStorage.setItem('danmeiInvoiceData', JSON.stringify(saveData));
            alert('資料已成功儲存到本地！');
        }

        // 從本地儲存加載
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('danmeiInvoiceData');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    clients = data.clients || [];
                    clientCounter = data.clientCounter || 1;
                    activeClientId = data.activeClientId || 0;
                    firstSalespersonSelected = data.firstSalespersonSelected || "";
                    isFirstSalespersonSelected = data.isFirstSalespersonSelected || false;
                    
                    // 重建UI
                    clients.forEach(client => {
                        createTab(client);
                        createInvoiceContent(client);
                    });
                    
                    // 激活最後活躍的客戶
                    if (activeClientId > 0) {
                        switchClient(activeClientId);
                    } else if (clients.length > 0) {
                        switchClient(clients[0].id);
                    }
                    
                    // 更新所有發貨單的業務員顯示
                    if (isFirstSalespersonSelected && firstSalespersonSelected) {
                        updateAllInvoicesSalesperson();
                    }
                    
                    console.log('資料已從本地儲存加載');
                } catch (e) {
                    console.error('加載本地儲存資料失敗:', e);
                }
            }
        }

        // 下載CSV檔案
        function downloadCSV() {
            if (clients.length === 0) {
                alert('沒有資料可以下載！');
                return;
            }
            
            // 創建CSV內容
            let csvContent = "data:text/csv;charset=utf-8,\ufeff";
            
            // 添加標題行
            const headers = [
                "客戶ID",
                "客戶名稱",
                "發貨單號",
                "業務員",
                "日期",
                "電話",
                "地址",
                "送貨方式",
                "總金額",
                "總項數"
            ];
            
            // 添加產品標題
            products.forEach(product => {
                headers.push(`產品${product.id}_數量`);
                headers.push(`產品${product.id}_搭贈`);
                headers.push(`產品${product.id}_金額`);
                headers.push(`產品${product.id}_選擇`);
            });
            
            csvContent += headers.join(",") + "\n";
            
            // 添加每一行客戶資料
            clients.forEach(client => {
                const row = [];
                
                // 基本客戶資料
                row.push(client.id);
                row.push(`"${client.clientData.name || ''}"`);
                row.push(`"${client.invoiceNumber || ''}"`);
                row.push(`"${client.salesperson || ''}"`);
                row.push(`"${client.date.year}/${client.date.month}/${client.date.day}"`);
                row.push(`"${client.clientData.phone || ''}"`);
                row.push(`"${client.clientData.address || ''}"`);
                row.push(`"${client.delivery === 'sales' ? '業務員' : '貨運行'}"`);
                
                // 計算總金額和項數
                let totalAmount = 0;
                let itemCount = 0;
                
                client.products.forEach(product => {
                    if (product.amount && product.amount > 0) {
                        itemCount++;
                        totalAmount += product.amount || 0;
                    }
                });
                
                row.push(totalAmount);
                row.push(itemCount);
                
                // 添加每個產品的數量、搭贈、金額和選擇
                client.products.forEach(product => {
                    row.push(product.quantity || 0);
                    row.push(product.gift || 0);
                    row.push(product.amount || 0);
                    row.push(`"${product.selections ? product.selections.join(', ') : ''}"`);
                });
                
                csvContent += row.join(",") + "\n";
            });
            
            // 創建下載連結
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `丹美發貨單_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            
            // 觸發下載
            link.click();
            document.body.removeChild(link);
            
            alert('CSV檔案下載完成！');
        }

        // 鎖定頁面
        function lockPage() {
            isLocked = true;
            applyLockStyle();
            alert('頁面已鎖定，無法編輯！');
        }

        // 解鎖頁面
        function unlockPage() {
            isLocked = false;
            removeLockStyle();
            alert('頁面已解鎖，可以編輯！');
        }

        // 應用鎖定樣式
        function applyLockStyle() {
            document.getElementById('tabs-container').classList.add('locked');
        }

        // 移除鎖定樣式
        function removeLockStyle() {
            document.getElementById('tabs-container').classList.remove('locked');
        }

        // 顯示清除客戶數據確認視窗
        function showClearClientModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const clientName = client.clientData.name || `客戶 ${clientId}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3>確認清除</h3>
                    <p>請問確定要清除此分頁(${clientName})的數據嗎？</p>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">不要清除</button>
                        <button class="modal-btn modal-confirm">確認清除</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 確認清除
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                clearClientData(clientId);
                document.body.removeChild(modal);
            });
            
            // 取消
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }

        // 顯示清除全部數據確認視窗
        function showClearAllModal() {
            if (isLocked) {
                alert('頁面已鎖定，無法清除數據');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3>確認清除全部數據</h3>
                    <p>請問確定要清除全部的數據嗎？</p>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">不要清除</button>
                        <button class="modal-btn modal-confirm">確認清除</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 確認清除
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                clearAllData();
                document.body.removeChild(modal);
            });
            
            // 取消
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }

        // 清除全部數據
        function clearAllData() {
            // 清除所有客戶數據
            clients.forEach(client => {
                clearClientData(client.id);
            });
            
            // 重置業務員選擇
            firstSalespersonSelected = "";
            isFirstSalespersonSelected = false;
            
            // 更新所有發貨單的業務員顯示
            updateAllInvoicesSalesperson();
            
            alert('全部數據已清除！');
        }

        // 顯示關閉分頁確認視窗
        function showCloseTabModal(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const clientName = client.clientData.name || `客戶 ${clientId}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <h3>確認關閉分頁</h3>
                    <p>請問是否要關閉此分頁(${clientName})？</p>
                    <div class="modal-buttons">
                        <button class="modal-btn modal-cancel">不要關閉</button>
                        <button class="modal-btn modal-confirm">關閉分頁(${clientName})</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 確認關閉
            modal.querySelector('.modal-confirm').addEventListener('click', function() {
                removeClient(clientId);
                document.body.removeChild(modal);
            });
            
            // 取消
            modal.querySelector('.modal-cancel').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
        }

        // 更新所有發貨單的業務員顯示
        function updateAllInvoicesSalesperson() {
            clients.forEach(client => {
                // 更新業務簽名顯示
                const signatureSpan = document.getElementById(`sales-signature-${client.id}`);
                if (signatureSpan) {
                    signatureSpan.textContent = firstSalespersonSelected || '___________________';
                }
                
                // 更新業務員顯示區域
                const salespersonDisplay = document.querySelector(`#invoice-${client.id} .salesperson-display`);
                if (salespersonDisplay) {
                    salespersonDisplay.textContent = firstSalespersonSelected;
                }
                
                // 更新標題區域
                const salespersonTitle = document.querySelector(`#invoice-${client.id} .salesperson-title`);
                if (salespersonTitle) {
                    salespersonTitle.textContent = firstSalespersonSelected;
                }
            });
        }

        // 更新簽收者日期顯示
        function updateReceiverDate(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            const receiverDateSpan = document.getElementById(`receiver-date-${clientId}`);
            if (receiverDateSpan) {
                receiverDateSpan.textContent = `${client.date.year}/${client.date.month}/${client.date.day}`;
            }
        }

        // 切換客戶
        function switchClient(clientId) {
            // 更新活躍客戶ID
            activeClientId = clientId;
            
            // 更新分頁標籤狀態
            document.querySelectorAll('.tab').forEach(tab => {
                if (parseInt(tab.dataset.clientId) === clientId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // 顯示/隱藏發貨單內容
            document.querySelectorAll('.invoice-container').forEach(container => {
                if (parseInt(container.dataset.clientId) === clientId) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
            });
        }

        // 移除客戶
        function removeClient(clientId) {
            // 從客戶列表中移除
            clients = clients.filter(c => c.id !== clientId);
            
            // 更新客戶計數
            document.getElementById('client-count').textContent = clients.length;
            
            // 移除分頁標籤
            const tab = document.querySelector(`.tab[data-client-id="${clientId}"]`);
            if (tab) tab.remove();
            
            // 移除發貨單內容
            const invoiceDiv = document.getElementById(`invoice-${clientId}`);
            if (invoiceDiv) invoiceDiv.remove();
            
            // 如果刪除的是當前活躍客戶，切換到第一個客戶
            if (activeClientId === clientId && clients.length > 0) {
                switchClient(clients[0].id);
            }
        }

        // 為客戶設置事件監聽器
        function setupEventListenersForClient(clientId) {
            // 業務員選擇變更（只有第一個分頁且尚未選擇業務員時才有效）
            const salespersonSelect = document.getElementById(`salesperson-${clientId}`);
            if (salespersonSelect && clientId === 1 && !isFirstSalespersonSelected) {
                salespersonSelect.addEventListener('change', function() {
                    if (this.value) {
                        // 設置第一個業務員選擇
                        firstSalespersonSelected = this.value;
                        isFirstSalespersonSelected = true;
                        
                        // 更新所有客戶的業務員
                        clients.forEach(client => {
                            client.salesperson = firstSalespersonSelected;
                        });
                        
                        // 更新所有分頁的顯示
                        updateAllInvoicesSalesperson();
                    }
                });
            }
            
            // 發貨單號變更
            const invoiceNumberInput = document.getElementById(`invoice-number-${clientId}`);
            if (invoiceNumberInput) {
                invoiceNumberInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.invoiceNumber = this.value;
                    }
                });
            }
            
            // 客戶資料變更
            const clientNameInput = document.getElementById(`client-name-${clientId}`);
            if (clientNameInput) {
                clientNameInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.clientData.name = this.value;
                        updateTabName(clientId);
                    }
                });
                
                clientNameInput.addEventListener('input', function() {
                    updateTabName(clientId);
                });
            }
            
            const clientPhoneInput = document.getElementById(`client-phone-${clientId}`);
            if (clientPhoneInput) {
                clientPhoneInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.clientData.phone = this.value;
                    }
                });
            }
            
            const clientAddressInput = document.getElementById(`client-address-${clientId}`);
            if (clientAddressInput) {
                clientAddressInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.clientData.address = this.value;
                    }
                });
            }
            
            // 日期變更 - 更新簽收者日期
            const yearInput = document.getElementById(`year-${clientId}`);
            if (yearInput) {
                yearInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.date.year = parseInt(this.value);
                        updateReceiverDate(clientId);
                    }
                });
            }
            
            const monthInput = document.getElementById(`month-${clientId}`);
            if (monthInput) {
                monthInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.date.month = parseInt(this.value);
                        updateReceiverDate(clientId);
                    }
                });
            }
            
            const dayInput = document.getElementById(`day-${clientId}`);
            if (dayInput) {
                dayInput.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.date.day = parseInt(this.value);
                        updateReceiverDate(clientId);
                    }
                });
            }
            
            // 送貨方式變更
            const deliveryRadios = document.querySelectorAll(`input[name="delivery-${clientId}"]`);
            deliveryRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        client.delivery = this.value;
                    }
                });
            });
        }
    </script>
</body>
</html>